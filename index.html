<!DOCTYPE html>
<html>

<head>
    <title>無人島計算機</title>
    <!-- bootstrap 3 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" />
    <!-- font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <style>
        .table>:not(caption)>*>* {
            padding: .1rem .5rem;
        }
    </style>

    <div class="container">
        <br />
    </div>

    <template class="ws">
        <div class="pWorkshop">
            <h4 class="title">工坊一號</h4>
            <div class="row">
                <div class="col col-1 form-inline">工坊等級</div>
                <div class="col col-1"><select class="wsLV form-control"></select></div>
                <div class="col col-1">起始幹勁</div>
                <div class="col col-1"><select class="defDrive form-control"></select></div>
                <div class="col col-2">完成一項產品幹勁加</div>
                <div class="col col-1"><select class="addDrive form-control"></select></div>
            </div>
            <table class="pTable table table-bordered">
                <colgroup>
                    <col style="width: 350px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 100px">
                    <col style="width: 10px">
                </colgroup>
                <tbody>
                    <tr>
                        <th><label>島產品</label></th>
                        <th><label>描述</label></th>
                        <th><label>特性1</label></th>
                        <th><label>特性2</label></th>
                        <th><label>耗時</label></th>
                        <th><label>人氣度</label></th>
                        <th><label>需要</label></th>
                        <th><label>基本售價</label></th>
                        <th><label>生產個數</label></th>
                        <th><label>預測所得</label></th>
                        <th><label>↓</label></th>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="pTr">
                        <td><select class="product" class="form-control"></select></td>
                        <td><label class="desc"></label></td>
                        <td><label class="prop1"></label></td>
                        <td><label class="prop2"></label></td>
                        <td><label class="hour"></label></td>
                        <td><label class="pop"></label></td>
                        <td><label class="need"></label></td>
                        <td><label class="price"></label></td>
                        <td><label class="num"></label></td>
                        <td><label class="predict"></label></td>
                        <td><label class="tab">↓</label></td>
                    </tr>
                    <tr class="sumTr">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td><label class="total"></label></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <div id="app">{{ message }}</div>
</body>
<!-- jQuery Core -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
    integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"
    integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
<!-- bootstrap 3 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<!-- select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- vue -->
<script src="https://unpkg.com/vue@3"></script>
<script>
    $(document).ready(async function () {
        init();
        loadHist();
        doPredict();
    })

    /*島產品下拉選單OnSelect*/
    function productOnSelect(select, selData) {
        saveHist();
        showStaticData(select);
        doPredict();
    }

    function showStaticData(select) {
        if (select != undefined && $(select).val()) {
            let obj = $(select).select2('data')[0];
            $.each(Object.keys(obj), function (i, key) {
                let theLabel = $(select).closest("tr").find("." + key).text(obj[key]);
            })
        }
    }

    /*計算預測所得*/
    function doPredict() {
        $(".pWorkshop").each(function () {
            const wsLV = $(this).find(".wsLV").val();
            const defDrive = parseInt($(this).find(".defDrive").val());
            const addDrive = parseInt($(this).find(".addDrive").val());
            let prevProp1 = ""; let prevProp2 = ""; let sum = 0; let drive = defDrive;

            $(this).find(".pTr").each(function () {
                const select = $(this).find(".product");
                if (select != undefined && $(select).val()) {
                    let obj = $(select).select2('data')[0];
                    let num = ((prevProp1 != "" && prevProp1 == obj.prop1) || (prevProp2 != "" && prevProp2 == obj.prop2)) ? 2 : 1;
                    console.log(drive);
                    let predictVal = Math.floor(Math.floor(obj.price * wsLV) * (1 + (drive * 0.01)) * vPop[obj.pop] * vNeed[obj.need] * num);
                    let detail = `${obj.price} x${wsLV}(工坊等級) x${(1 + (drive * 0.01))}(幹勁) x${vPop[obj.pop]}(人氣) xx`;
                    $(this).find(".num").text(num);
                    $(this).find(".predict").text(isNaN(predictVal) ? 0 : predictVal);
                    $("<tr><td>" + detail + "</td></tr>").insertAfter($(this));
                    sum += isNaN(predictVal) ? 0 : predictVal;
                    prevProp1 = obj.prop1; prevProp2 = obj.prop2; drive += addDrive;
                }
                else {
                    prevProp1 = ""; prevProp2 = "";
                    $(this).find("label").text("");
                }
            });
            $(this).find(".total").text(sum);
        });
    }

    function loadHist() {
        let theHist = JSON.parse(localStorage.getItem("theHist"));
        $.each(theHist, function (i, item) {
            let ws = $(".pWorkshop").eq(i);
            $(ws).find(".wsLV").val(theHist[i].wsLV).trigger('change');
            $(ws).find(".defDrive").val(theHist[i].defDrive).trigger('change');
            $(ws).find(".addDrive").val(theHist[i].addDrive).trigger('change');
            let prodsIdx = 0;
            $(ws).find(".product").each(function () {
                let id = theHist[i].prods[prodsIdx++];
                $(this).val(id).trigger('change');
                showStaticData(this);
            })
        })
    }

    function saveHist() {
        let theHist = [];
        $(".pWorkshop").each(function () {
            let wsLV = $(this).find(".wsLV").val();
            let defDrive = $(this).find(".defDrive").val();
            let addDrive = $(this).find(".addDrive").val();
            let vWorkshop = { "wsLV": wsLV, "defDrive": defDrive, "addDrive": addDrive, "prods": [] };
            $(this).find(".pTr").each(function () {
                vWorkshop.prods.push($(this).find(".product").val())
            });
            theHist.push(vWorkshop);
        });
        localStorage.setItem("theHist", JSON.stringify(theHist));
    }

    /*畫面初始化*/
    function init() {
        /*建立表格*/
        var ws1 = $($("template.ws").html()).clone();
        var ws2 = $($("template.ws").html()).clone();
        var ws3 = $($("template.ws").html()).clone();
        $(ws1).find(".title").text("工坊一號");
        $(ws2).find(".title").text("工坊二號");
        $(ws3).find(".title").text("工坊三號");
        $(".container").append($(ws1));
        $(".container").append($(ws2));
        $(".container").append($(ws3));

        /*工坊等級*/
        $(".wsLV").append($("<option/>").text("Lv I").val("1"));
        $(".wsLV").append($("<option/>").text("Lv II").val("1.1"));
        $(".wsLV").append($("<option/>").text("Lv III").val("1.2"));
        $(".wsLV").val("1.2");
        $(".wsLV").select2({
            minimumResultsForSearch: -1
        }).val(1).trigger('change').on('select2:select', saveHist);

        /*起始幹勁*/
        for (var i = 0; i <= 35; i++) {
            $(".defDrive").append($("<option/>").text(i).val(i));
        }
        $(".defDrive").select2({
            minimumResultsForSearch: -1
        }).val(0).trigger('change').on('select2:select', saveHist);

        /*完成一項產品幹勁加*/
        for (var i = 0; i <= 3; i++) {
            $(".addDrive").append($("<option/>").text(i).val(i));
        }
        $(".addDrive").select2({
            minimumResultsForSearch: -1
        }).val(0).trigger('change').on('select2:select', saveHist);

        /*設定島產品下拉選單*/
        /*選項*/
        var select2data = $.map(vData, function (obj) {
            obj.text = "｜" + obj.hour + "｜" + obj.price + "｜" + obj.prop1 + "｜" + obj.prop2 + "｜" + obj.nameJP + "｜" + obj.desc;
            return obj;
        });
        //$.fn.select2.defaults.set("allowClear", "true");
        $("select.product").select2({
            data: select2data,
            width: "350px",
            allowClear: true,
            dropdownAutoWidth: true,
            placeholder: "-- 請選擇 --",
        }).val(null).trigger('change')
            .on('select2:select', function (e) { productOnSelect(this, e.params.data); });
        //$.fn.select2.defaults.reset();
    }

    let vPop = { "大人氣": 1.4, "人氣": 1.2, "普通": 1, "不人氣": 0.8 };
    let vNeed = { "超供給不足": 1.6, "供給不足": 1.3, "普通": 1, "供給過多": 0.8, "超供給過多": 0.6 };
    var vData = [
        {
            "id": "1",
            "nameJP": "アイルポーション",
            "desc": "藍藥水",
            "hour": "4",
            "price": "30",
            "prop1": "藥品",
            "prop2": "--",
            "pop": "大人氣",
            "need": "供給不足",
        },
        {
            "id": "2",
            "nameJP": "開拓工房の火薬",
            "desc": "火藥",
            "hour": "4",
            "price": "30",
            "prop1": "藥品",
            "prop2": "窯業製品",
            "pop": "人氣",
            "need": "超供給不足",
        },
        {
            "id": "3",
            "nameJP": "アイルウッドチェア",
            "desc": "木椅",
            "hour": "6",
            "price": "46",
            "prop1": "調度品",
            "prop2": "木工製品",
            "pop": "不人氣",
            "need": "普通",
        }
    ];
</script>

</html>