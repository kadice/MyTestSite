<div class="row">
    <div class="col-lg-11 col-xxl-10 mx-auto">
        <div id="appRanking">
            <h4>{{ appTitle }}</h4>
            <div>
                <div style="display: flex;">

                    <button type="button" class="btn btn-lg btn-warning mx-auto"
                        v-on:click="getRanking">　按　下　我　獲　得　解　脫　</button>

                </div>
            </div>
            <table id="tbRanking" class="table">
                <thead>
                    <tr>
                        <th style="max-width: 40px">排名</th>
                        <th style="max-width: auto">島產品1</th>
                        <th style="max-width: auto">島產品2</th>
                        <th style="max-width: auto">島產品3</th>
                        <th style="max-width: auto">島產品4</th>
                        <th style="max-width: auto">島產品5</th>
                        <th style="max-width: auto">島產品6</th>
                        <th style="max-width: 50px">總價</th>
                        <th style="width: 100px"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item,index) in ranking">
                        <td>
                            <label v-text="index+1"></label>
                        </td>
                        <td v-for="(prod, pIdx) in item.schedule">
                            <label>{{prod.desc}}</label><br />
                            <small> |{{prod.pop}} |{{prod.need}} |{{prod.priceX}}</small>
                        </td>
                        <td v-for="i in (6-item.schedule.length)">
                            <label>--</label>
                        </td>
                        <td>
                            <label v-text="Math.floor(item.totalPriceX*100)/100"></label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
    })
    Vue.createApp({
        data() {
            return {
                appTitle: "救救可憐光戰",
                ranking: [],
            }
        },
        methods: {
            getRanking() {
                let myRawProds = JSON.parse(localStorage.myRawProds);

                //移除無法生產的產品
                myRawProds = myRawProds.filter(m => m.mark == true);

                //第一層
                var scheduleList = myRawProds.map((m) => ({ schedule: [m], totalHours: m.hour, totalPriceX: 0.0 + m.priceX }));
                //第二～六層
                for (let i = 0; i < 5; i++) {
                    scheduleList = scheduleList.flatMap(ori => {
                        let last = ori.schedule[ori.schedule.length - 1];
                        let replacement = myRawProds
                            //找出與last特性相同且總耗時<=24的產品
                            .filter(m1 => m1.id != last.id
                                && ((m1.prop1 != "" && m1.prop1 == last.prop1) || (m1.prop2 != "" && m1.prop2 == last.prop2))
                                && (m1.hour + ori.totalHours <= 24))
                            //檢查產品重複次數，已出現兩次就不放入
                            .filter(m2 => ori.schedule.filter(m3 => m3.id == m2.id).length < 2)
                            //對此產品做檢查，並回傳處理結果
                            .map(m4 => {
                                let newEle = JSON.parse(JSON.stringify(ori));
                                newEle.schedule.push(m4);
                                newEle.totalHours += m4.hour;
                                newEle.totalPriceX += m4.priceX * 2.0;
                                return newEle;
                            });
                        return (replacement.length > 0) ? replacement : [ori];
                    });
                }
                //處理只是順序不同的重複組合
                const set = new Set();
                scheduleList = scheduleList.filter(m => {
                    const mySet = m.schedule.map(m2 => m2.id).sort();
                    if (set.has(JSON.stringify(mySet))) {
                        return false;
                    }
                    else {
                        return set.add(JSON.stringify(mySet));
                    }
                });

                //排序
                scheduleList = scheduleList.sort((a, b) => b.totalPriceX - a.totalPriceX);
                //取前20
                scheduleList = scheduleList.slice(0, 20);

                this.ranking = scheduleList;
                setTimeout(() => {
                    $("#tbRanking").datatable()
                }, 250) //customize this
            }
        },

    }).mount('#appRanking');
</script>